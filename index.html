-- ===== SQL DE EMERGÊNCIA - CORRIGIR TABELA =====
-- Execute este SQL no Editor SQL do Supabase para resolver o problema

-- 1. Primeiro, vamos ver o que temos na tabela
SELECT * FROM public.tunings LIMIT 5;

-- 2. Verificar a estrutura atual da tabela
SELECT 
    column_name, 
    data_type, 
    is_nullable,
    column_default
FROM information_schema.columns 
WHERE table_name = 'tunings' 
ORDER BY ordinal_position;

-- 3. Se a tabela estiver vazia ou com problemas, vamos recriar de forma segura
-- Primeiro, vamos fazer backup dos dados existentes (se houver)
CREATE TABLE IF NOT EXISTS tunings_backup AS 
SELECT * FROM public.tunings;

-- 4. Agora vamos recriar a tabela com a estrutura correta
DROP TABLE IF EXISTS public.tunings CASCADE;

CREATE TABLE public.tunings (
    id SERIAL PRIMARY KEY,
    discord_user_id TEXT,
    mechanic_name TEXT NOT NULL,
    mechanic_username TEXT,
    mechanic_avatar TEXT,
    client TEXT NOT NULL,
    passport TEXT NOT NULL,
    tunings JSONB NOT NULL,
    total INTEGER NOT NULL,
    date TEXT NOT NULL,
    timestamp TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 5. Criar índices básicos
CREATE INDEX idx_tunings_discord_user_id ON public.tunings(discord_user_id);
CREATE INDEX idx_tunings_created_at ON public.tunings(created_at DESC);

-- 6. Habilitar RLS de forma simples
ALTER TABLE public.tunings ENABLE ROW LEVEL SECURITY;

-- 7. Criar políticas básicas (permitir tudo por enquanto)
CREATE POLICY "Permitir tudo" ON public.tunings
    FOR ALL USING (true);

-- 8. Verificar se a tabela foi criada corretamente
SELECT 
    column_name, 
    data_type, 
    is_nullable,
    column_default
FROM information_schema.columns 
WHERE table_name = 'tunings' 
ORDER BY ordinal_position;

-- 9. Verificar se as políticas foram criadas
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd
FROM pg_policies 
WHERE tablename = 'tunings';

-- 10. Testar inserção de uma linha de teste
INSERT INTO public.tunings (
    discord_user_id,
    mechanic_name,
    mechanic_username,
    mechanic_avatar,
    client,
    passport,
    tunings,
    total,
    date,
    timestamp
) VALUES (
    'test_user_123',
    'Mecânico Teste',
    'teste_user',
    'teste_avatar',
    'Cliente Teste',
    '12345',
    '[{"name": "Motor Nível 1", "price": 15000}]',
    15000,
    '2024-01-01 12:00:00',
    '2024-01-01T12:00:00Z'
);

-- 11. Verificar se a inserção funcionou
SELECT * FROM public.tunings;

-- 12. Se tudo estiver funcionando, remover a linha de teste
DELETE FROM public.tunings WHERE client = 'Cliente Teste';

-- ===== FIM DO SQL DE EMERGÊNCIA =====
-- Execute tudo acima no Editor SQL do Supabase
-- Depois teste criando uma tunagem no site
